#####################################
#     ARGB Lights Configuration      #
#####################################
# Macros for setting ARGB lights on custom Switchwire printer
# (15 grill LEDs + 1-2 toolhead LED(s))
#
# Configuration:
#   - LEDs 1-15: Grill/base lighting
#   - LED 16:    Toolhead accent LED
#
# How to use:
#   1. Add [include argb_lights.cfg] to your main printer.cfg
#   2. Call STATUS_**** macros in your other gcode macros
#   3. Customize colors in the [led_effect] sections below
#
#####################################

[neopixel ARGB_Chain]
pin: PB1
chain_count: 16
#   (15 grill LEDs + 1 toolhead LED)
color_order: GRB
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 0.0


##########
# MACROS #
##########

# Available status macros (call these from your gcode):
#   STATUS_READY           - Ready to print state
#   STATUS_OFF             - All LEDs off
#   STATUS_HEATING         - Hotend/bed heating
#   STATUS_LEVELING        - Mesh leveling in progress
#   STATUS_HOMING          - Homing axes
#   STATUS_CLEANING        - Nozzle cleaning
#   STATUS_MESHING         - Mesh bed leveling
#   STATUS_CALIBRATING_Z   - Z offset calibration
#   STATUS_PRINTING        - Currently printing
#   STATUS_ERROR           - Error state (blinks red)


# ============
# Status Macros
# ============

[gcode_macro status_off]
gcode:
    STOP_LED_EFFECTS

[gcode_macro status_ready]
gcode:
    SET_LED_EFFECT EFFECT=idle REPLACE=1

[gcode_macro status_heating]
gcode:
    SET_LED_EFFECT EFFECT=heating REPLACE=1

[gcode_macro status_leveling]
gcode:
    SET_LED_EFFECT EFFECT=meshing REPLACE=1

[gcode_macro status_homing]
gcode:
    SET_LED_EFFECT EFFECT=homing REPLACE=1

[gcode_macro status_cleaning]
gcode:
    SET_LED_EFFECT EFFECT=cleaning REPLACE=1

[gcode_macro status_meshing]
gcode:
    SET_LED_EFFECT EFFECT=meshing REPLACE=1

[gcode_macro status_calibrating_z]
gcode:
    SET_LED_EFFECT EFFECT=meshing REPLACE=1

[gcode_macro status_printing]
gcode:
    SET_LED_EFFECT EFFECT=printing REPLACE=1

[gcode_macro status_error]
gcode:
    SET_LED_EFFECT EFFECT=error REPLACE=1


# ============================
# Deprecated/Legacy Macros
# ============================
# These macros are kept as backup for direct LED control
# if needed. Normally, use the STATUS_* macros above and
# LED effects. Uncomment/use only if needed.

[gcode_macro _argb_vars]
# User settings for ARGB status LEDs (for legacy methods)
# You can customize colors for different states here
variable_colors: {
        'grill': { # Colors for grill/base LEDs
            'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0},
            'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5},
            'calibrating_z': {'r': 0.8, 'g': 0.0, 'b': 0.35},
            'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0},
            'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2},
            'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4},
            'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0},
            'off': {'r': 0.0, 'g': 0.0, 'b': 0.0},
            'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0},
            'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01},
        },
        'toolhead': { # Colors for toolhead accent LED
            'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0},
            'off': {'r': 0.0, 'g': 0.0, 'b': 0.0},
            'on': {'r': 0.8, 'g': 0.8, 'b': 0.8},
            'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0},
        }
    }
variable_grill_led_name: "ARGB_Chain"
variable_grill_idx: "15,14,13,12,11,10,9,8,7,6,5,4,3,2,1"
variable_toolhead_led_name: "ARGB_Chain"
variable_toolhead_idx: "16"
gcode:
    # This section is required. Do Not Delete.

[gcode_macro _set_argb_leds]
gcode:
    {% set red = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue = params.BLUE|default(0)|float %}
    {% set led = params.LED|string %}
    {% set idx = (params.IDX|string).split(',') %}
    {% set transmit_last = params.TRANSMIT|default(1) %}

    {% for led_index in idx %}
        {% set transmit=transmit_last if loop.last else 0 %}
        set_led led={led} red={red} green={green} blue={blue} index={led_index} transmit={transmit}
    {% endfor %}

[gcode_macro _set_argb_leds_by_name]
gcode:
    {% set leds_name = params.LEDS %}
    {% set color_name = params.COLOR %}
    {% set color = printer["gcode_macro _argb_vars"].colors[leds_name][color_name] %}
    {% set led = printer["gcode_macro _argb_vars"][leds_name + "_led_name"] %}
    {% set idx = printer["gcode_macro _argb_vars"][leds_name + "_idx"] %}
    {% set transmit = params.TRANSMIT|default(1) %}

    _set_argb_leds led={led} red={color.r} green={color.g} blue={color.b} idx="{idx}" transmit={transmit}

[gcode_macro _set_grill_leds]
gcode:
    {% set red = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue = params.BLUE|default(0)|float %}
    {% set led = printer["gcode_macro _argb_vars"].grill_led_name %}
    {% set idx = printer["gcode_macro _argb_vars"].grill_idx %}
    {% set transmit=params.TRANSMIT|default(1) %}

    _set_argb_leds led={led} red={red} green={green} blue={blue} idx="{idx}" transmit={transmit}

[gcode_macro _set_toolhead_led]
gcode:
    {% set red = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue = params.BLUE|default(0)|float %}
    {% set led = printer["gcode_macro _argb_vars"].toolhead_led_name %}
    {% set idx = printer["gcode_macro _argb_vars"].toolhead_idx %}
    {% set transmit=params.TRANSMIT|default(1) %}

    _set_argb_leds led={led} red={red} green={green} blue={blue} idx="{idx}" transmit={transmit}

[gcode_macro set_grill_leds_off]
gcode:
    {% set transmit=params.TRANSMIT|default(1) %}
    _set_grill_leds red=0 green=0 blue=0 transmit={transmit}

[gcode_macro set_toolhead_led_on]
gcode:
    {% set transmit=params.TRANSMIT|default(1) %}
    {% set c = printer["gcode_macro _argb_vars"].colors['toolhead']['on'] %}
    _set_toolhead_led red={c.r} green={c.g} blue={c.b} transmit={transmit}

[gcode_macro set_toolhead_led_off]
gcode:
    {% set transmit=params.TRANSMIT|default(1) %}
    {% set c = printer["gcode_macro _argb_vars"].colors['toolhead']['off'] %}
    _set_toolhead_led red={c.r} green={c.g} blue={c.b} transmit={transmit}


# ==================
# LED Effects
# ==================
# Animations using klipper-led_effect plugin
# https://github.com/julianschill/klipper-led_effect

[led_effect idle]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    static 0 0 top (0.01, 0.01, 0.01)

[led_effect heating]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    breathing 2 0 top (0.3, 0.18, 0.0)

[led_effect printing]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    progress -1.00 0.00 add (0.13,.600,0.00),(0.02,0.59,0.0) 
    static 0.00 0.00 top (0.0,0.01,0.01)

[led_effect homing]
autostart: false
frame_rate: 24
stepper: stepper_x, stepper_y, stepper_z
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    static 1.00 0.00 add (0.10,0.05,0) 
    homing 1.00 1.00 add (1.0,0.0,0.0) 


[led_effect meshing]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    breathing 2 0 top (0.2, 1.0, 0.0)

[led_effect cleaning]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    strobe 1 2 top (0.0, 0.02, 0.5), (0.0, 0.0, 0.0)

[led_effect error]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    strobe 2 1 top (0.8, 0.0, 0.0), (0.0, 0.0, 0.0)

# macros ovverrides
[gcode_macro G28]
rename_existing: G28.1
gcode:
    STATUS_HOMING
    G28.1 {rawparams}