#####################################
#     ARGB Lights Configuration      #
#####################################
# Macros for setting ARGB lights on custom Switchwire printer
# (15 grill LEDs + 1-2 toolhead LED(s))
#
# Configuration:
#   - LEDs 1-15: Grill/base lighting
#   - LED 16:    Toolhead accent LED
#
# How to use:
#   1. Add [include argb_lights.cfg] to your main printer.cfg
#   2. Call STATUS_**** macros in your other gcode macros
#      Example: Add STATUS_BUSY at print start, STATUS_READY at print end
#   3. Modify colors in [gcode_macro _argb_vars] as desired
#
#####################################

[neopixel ARGB_Chain]
pin: PB1
#   The pin connected to the neopixel. This parameter must be provided.
chain_count: 16
#   The number of Neopixel chips that are "daisy chained" to the provided pin.
#   (15 grill LEDs + 1 toolhead LED)
color_order: GRB
#   Set the pixel order required by your LED hardware
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 0.0
#   Start LEDs in off state


##########
# MACROS #
##########

# Available status macros:
#   STATUS_READY       - Ready to print (subtle standby glow)
#   STATUS_OFF         - All LEDs off
#   STATUS_BUSY        - Busy with a task
#   STATUS_HEATING     - Hotend/bed heating
#   STATUS_LEVELING    - Mesh leveling in progress
#   STATUS_HOMING      - Homing axes
#   STATUS_CLEANING    - Nozzle cleaning
#   STATUS_MESHING     - Mesh bed leveling
#   STATUS_CALIBRATING_Z - Z offset calibration
#   STATUS_PRINTING    - Currently printing
#
# Control macros:
#   SET_GRILL_LEDS_ON  - Turn grill LEDs on
#   SET_GRILL_LEDS_OFF - Turn grill LEDs off
#   SET_TOOLHEAD_LED_ON  - Turn toolhead LED on
#   SET_TOOLHEAD_LED_OFF - Turn toolhead LED off


[gcode_macro _argb_vars]
# User settings for ARGB status LEDs
# You can customize colors for different states here
variable_colors: {
        'grill': { # Colors for grill/base LEDs
            'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0},
            'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5},
            'calibrating_z': {'r': 0.8, 'g': 0.0, 'b': 0.35},
            'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0},
            'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2},
            'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4},
            'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0},
            'off': {'r': 0.0, 'g': 0.0, 'b': 0.0},
            'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0},
            'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01},
        },
        'toolhead': { # Colors for toolhead accent LED
            'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0},
            'off': {'r': 0.0, 'g': 0.0, 'b': 0.0},
            'on': {'r': 0.8, 'g': 0.8, 'b': 0.8},
            'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0},
        }
    }
variable_grill_led_name: "ARGB_Chain"
# LED chain name for grill LEDs
variable_grill_idx: "15,14,13,12,11,10,9,8,7,6,5,4,3,2,1"
# Grill LED indices (1-15, reversed)
variable_toolhead_led_name: "ARGB_Chain"
# LED chain name for toolhead LED
variable_toolhead_idx: "16"
# Toolhead LED index
gcode:
    # This section is required. Do Not Delete.


[gcode_macro _set_argb_leds]
gcode:
    {% set red = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue = params.BLUE|default(0)|float %}
    {% set led = params.LED|string %}
    {% set idx = (params.IDX|string).split(',') %}
    {% set transmit_last = params.TRANSMIT|default(1) %}

    {% for led_index in idx %}
        {% set transmit=transmit_last if loop.last else 0 %}
        set_led led={led} red={red} green={green} blue={blue} index={led_index} transmit={transmit}
    {% endfor %}

[gcode_macro _set_argb_leds_by_name]
gcode:
    {% set leds_name = params.LEDS %}
    {% set color_name = params.COLOR %}
    {% set color = printer["gcode_macro _argb_vars"].colors[leds_name][color_name] %}
    {% set led = printer["gcode_macro _argb_vars"][leds_name + "_led_name"] %}
    {% set idx = printer["gcode_macro _argb_vars"][leds_name + "_idx"] %}
    {% set transmit = params.TRANSMIT|default(1) %}

    _set_argb_leds led={led} red={color.r} green={color.g} blue={color.b} idx="{idx}" transmit={transmit}

[gcode_macro _set_grill_leds]
gcode:
    {% set red = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue = params.BLUE|default(0)|float %}
    {% set led = printer["gcode_macro _argb_vars"].grill_led_name %}
    {% set idx = printer["gcode_macro _argb_vars"].grill_idx %}
    {% set transmit=params.TRANSMIT|default(1) %}

    _set_argb_leds led={led} red={red} green={green} blue={blue} idx="{idx}" transmit={transmit}

[gcode_macro _set_toolhead_led]
gcode:
    {% set red = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue = params.BLUE|default(0)|float %}
    {% set led = printer["gcode_macro _argb_vars"].toolhead_led_name %}
    {% set idx = printer["gcode_macro _argb_vars"].toolhead_idx %}
    {% set transmit=params.TRANSMIT|default(1) %}

    _set_argb_leds led={led} red={red} green={green} blue={blue} idx="{idx}" transmit={transmit}

[gcode_macro set_grill_leds_off]
gcode:
    {% set transmit=params.TRANSMIT|default(1) %}
    _set_grill_leds red=0 green=0 blue=0 transmit={transmit}

[gcode_macro set_toolhead_led_on]
gcode:
    {% set transmit=params.TRANSMIT|default(1) %}
    _set_argb_leds_by_name leds="toolhead" color="on" transmit={transmit}

[gcode_macro set_toolhead_led_off]
gcode:
    {% set transmit=params.TRANSMIT|default(1) %}
    _set_argb_leds_by_name leds="toolhead" color="off" transmit={transmit}

# ============
# Status Macros
# ============

[gcode_macro status_off]
gcode:
    set_grill_leds_off transmit=0
    set_toolhead_led_off

[gcode_macro status_ready]
gcode:
    _set_argb_leds_by_name leds="grill" color="standby" transmit=0
    _set_argb_leds_by_name leds="toolhead" color="standby" transmit=1

[gcode_macro status_busy]
gcode:
    _set_argb_leds_by_name leds="grill" color="busy" transmit=0
    set_toolhead_led_on

[gcode_macro status_heating]
gcode:
    _set_argb_leds_by_name leds="grill" color="heating" transmit=0
    _set_argb_leds_by_name leds="toolhead" color="heating" transmit=1

[gcode_macro status_leveling]
gcode:
    _set_argb_leds_by_name leds="grill" color="leveling" transmit=0
    set_toolhead_led_on

[gcode_macro status_homing]
gcode:
    _set_argb_leds_by_name leds="grill" color="homing" transmit=0
    set_toolhead_led_on

[gcode_macro status_cleaning]
gcode:
    _set_argb_leds_by_name leds="grill" color="cleaning" transmit=0
    set_toolhead_led_on

[gcode_macro status_meshing]
gcode:
    _set_argb_leds_by_name leds="grill" color="meshing" transmit=0
    set_toolhead_led_on

[gcode_macro status_calibrating_z]
gcode:
    _set_argb_leds_by_name leds="grill" color="calibrating_z" transmit=0
    set_toolhead_led_on

[gcode_macro status_printing]
gcode:
    _set_argb_leds_by_name leds="grill" color="printing" transmit=0
    set_toolhead_led_on


# ==================
# LED Effects
# ==================
# Animations using klipper-led_effect plugin
# https://github.com/julianschill/klipper-led_effect

[led_effect idle]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    static 0 0 top (0.01, 0.01, 0.01)

[led_effect heating]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    breathing 2 0 top (0.3, 0.18, 0.0)

[led_effect printing]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    gradient 0.5 1 add (1.0, 0.0, 0.0), (0.8, 0.0, 0.0)
    breathing 2 0 top (0.4, 0.0, 0.0)

[led_effect homing]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    cylon 1 1 add (0.0, 0.6, 0.2)

[led_effect meshing]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    breathing 2 0 top (0.2, 1.0, 0.0)

[led_effect cleaning]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    strobe 1 2 top (0.0, 0.02, 0.5), (0.0, 0.0, 0.0)

[led_effect busy]
autostart: false
frame_rate: 24
leds:
    neopixel:ARGB_Chain (15-1)
layers:
    strobe 1 1 top (0.4, 0.0, 0.0), (0.0, 0.0, 0.0)

[led_effect progress_bar]
leds:
    neopixel:ARGB_Chain (15-1)
autostart:                          false
frame_rate:                         24
layers:
    progress  -1  0 add         ( 0, 0,   1),( 0, 0.1, 0.6)
    static     0  0 top         ( 0, 0, 0.1)